# Knip Cleanup Task Instructions

## Mission
Your mission is to make the command `bun knip` return no errors by systematically removing all **Unused exports** and fixing all **Duplicate exports**. You will work in a loop until the task is complete.

## Rules and Constraints

### 1. What to Fix
- **ONLY** fix "Unused exports" and "Duplicate exports"
- **DO NOT** attempt to fix: "Unused dependencies", "Unlisted dependencies", "Unlisted binaries", or "Unresolved imports" (these may be knip config issues)

### 2. Verification Strategy
- Run `bun knip` to get the current list of errors
- After making changes, run `bun knip` again to verify progress
- **Occasionally** (every 10-15 edits, not after every single edit) run `bun check` to ensure TypeScript compilation still works
- Continue in a loop until `bun knip` shows 0 unused exports and 0 duplicate exports

### 3. How to Handle Unused Exports

#### For Regular Exports (functions, constants, classes)
1. Read the file containing the unused export
2. Verify it's truly unused by checking if it's imported elsewhere using `grep`
3. If confirmed unused, remove the export keyword or delete the entire declaration if appropriate
4. If it's a type/interface that seems important for public API, keep it but verify usage

#### For Default Exports
1. Check if the file is imported elsewhere without being used
2. For React components marked as unused default exports, verify they're not dynamically imported or used in routing
3. Consider that some default exports might be used in ways knip doesn't detect (e.g., dynamic imports, route-based loading)

#### Special Cases
- **MCP/API endpoints**: Some exports might be used via MCP protocol or API endpoints. Check surrounding context before removing.
- **Test utilities**: Exports in test helper files are often legitimately unused in production code.
- **Types/Interfaces**: These might be used in ways that knip doesn't always detect. Be cautious.

### 4. How to Handle Duplicate Exports

Duplicate exports occur when multiple identifiers are exported with the same name from the same file. Examples:
- `export { app }` and `export default app` in the same file
- Multiple exports with identical names

**Resolution strategy:**
1. Read the file to understand which exports are duplicated
2. Check how the file is imported in other files using `grep`
3. Determine which export format is actually used (named vs default)
4. Remove the unused export format while keeping the one that's actually imported
5. If both are used, you may need to refactor imports in consuming files

Example patterns:
```typescript
// Bad - duplicate exports
export const app = hono()
export default app

// Good - choose one based on usage
export default app
// OR
export const app = hono()
```

### 5. Working in Batches
- Process files in batches (e.g., 5-10 files at a time)
- Group similar issues together (e.g., all API files, then all component files)
- After each batch, run `bun knip` to verify progress
- Every 10-15 file edits, run `bun check` to ensure no TypeScript errors were introduced

### 6. Safety Checks
- **Always** read a file before editing it to understand context
- **Never** blindly remove exports without verifying they're truly unused
- If uncertain about an export, use `grep` to search for its usage across the codebase
- Pay special attention to:
  - MCP tool definitions (packages/sdk/src/mcp/**/api.ts)
  - API route handlers (apps/api/src/**/*.ts)
  - React components used in routing (apps/web/src/components/**/*)
  - Type definitions that might be part of public APIs

### 7. Error Recovery
- If `bun check` shows TypeScript errors after your changes, immediately fix them before continuing
- If you remove something that breaks the build, restore it and mark it for manual review
- When in doubt, prefer keeping an export over removing it

### 8. Reporting Progress
- After each batch of changes, briefly state:
  - How many unused exports were removed
  - How many duplicate exports were fixed
  - Current error count from `bun knip`
  - Any issues or uncertainties encountered

### 9. Priority Order
1. First, fix all **Duplicate exports** (there are only 17 of these)
2. Then, systematically work through **Unused exports** by directory:
   - Start with `apps/api/src/` 
   - Then `apps/outbound/`
   - Then `apps/mesh/src/`
   - Then `apps/web/src/` (largest, will take most time)
   - Finally `packages/` directories

### 10. Loop Termination
- Continue until `bun knip` shows:
  - 0 Duplicate exports
  - 0 Unused exports
- Only then is the mission complete

## Example Workflow

```bash
# 1. Check current status
bun knip

# 2. Fix a batch of 5-10 files
# ... make edits ...

# 3. Verify progress
bun knip

# 4. Every 10-15 edits, check TypeScript
bun check

# 5. Repeat until complete
```

## Common Patterns to Watch For

### Pattern 1: Unused MCP API Exports
Files in `packages/sdk/src/mcp/*/api.ts` often have exports that look unused but are actually accessed via MCP protocol. Be cautious here.

### Pattern 2: React Component Default Exports
Many React components export both a named component and default export. Check which one is actually imported.

### Pattern 3: Utility Functions
Functions in `utils/` directories might be legitimately unused if they were created for future use. Verify with grep before removing.

### Pattern 4: Type Exports
TypeScript types/interfaces are often exported but knip may not detect their usage in all cases. Check carefully.

### Pattern 5: Re-exports
Files that re-export items from other files (barrel exports) need special attention to avoid breaking import paths.

## Files to Be Extra Careful With

- `apps/api/src/api.ts` - Main API routes
- `apps/api/src/app.ts` - App initialization  
- `apps/api/src/apps.ts` - Apps handling
- `packages/sdk/src/mcp/*/api.ts` - MCP API definitions
- `apps/web/src/main.tsx` - Web app entry point
- Any file with `index.ts` - Usually barrel exports

## Ready to Start?

Run `bun knip` to see the current errors, then begin with fixing the 17 duplicate exports first (easier), then systematically work through the 282 unused exports by directory.

Remember: **Be methodical, verify changes frequently, and prioritize build stability over aggressive cleanup.**
