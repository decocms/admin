<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authorize Application - MCP Mesh</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 600px;
      padding: 40px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header h1 {
      font-size: 24px;
      color: #333;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .client-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .client-info h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 8px;
    }

    .client-info p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }

    .permissions {
      margin-bottom: 24px;
    }

    .permissions h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 16px;
    }

    .permission-category {
      margin-bottom: 24px;
    }

    .permission-category h4 {
      font-size: 16px;
      color: #555;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }

    .permission-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      cursor: pointer;
      transition: background 0.2s;
    }

    .permission-item:hover {
      background: #e9ecef;
    }

    .permission-item.dangerous {
      background: #fff3cd;
    }

    .permission-item.dangerous:hover {
      background: #ffe69c;
    }

    .permission-item input[type="checkbox"] {
      margin-right: 12px;
      margin-top: 2px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .permission-content {
      flex: 1;
    }

    .permission-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .permission-description {
      color: #666;
      font-size: 13px;
    }

    .permission-item.dangerous .permission-name {
      color: #856404;
    }

    .select-all {
      margin-bottom: 16px;
      padding: 12px;
      background: #e7f3ff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .select-all input[type="checkbox"] {
      margin-right: 12px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .select-all label {
      font-weight: 600;
      color: #0066cc;
      cursor: pointer;
    }

    .actions {
      display: flex;
      gap: 12px;
    }

    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-authorize {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-authorize:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-deny {
      background: #f0f0f0;
      color: #666;
    }

    .btn-deny:hover:not(:disabled) {
      background: #e0e0e0;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .error.show {
      display: block;
    }

    .user-info {
      text-align: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #666;
    }

    .user-info strong {
      color: #333;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .selected-count {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>

    <div id="content" style="display: none;">
      <div class="header">
        <h1>Authorize Application</h1>
        <p>Select which permissions to grant</p>
      </div>

      <div class="error" id="error"></div>

      <div class="user-info" id="user-info">
        Signed in as <strong id="user-email">loading...</strong>
      </div>

      <div class="client-info">
        <h2 id="client-name">Application Access Request</h2>
        <p>This application is requesting access to your MCP Mesh account. Please review and select which permissions you want to grant.</p>
      </div>

      <div class="permissions">
        <h3>Requested Permissions</h3>
        
        <div class="select-all">
          <input type="checkbox" id="select-all" />
          <label for="select-all">Select All</label>
        </div>

        <div class="selected-count" id="selected-count">
          0 permissions selected
        </div>

        <div id="permissions-container">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-deny" id="btn-deny">Deny</button>
        <button type="button" class="btn-authorize" id="btn-authorize">Authorize</button>
      </div>
    </div>
  </div>

  <script>
    // Parse OAuth parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const oauthParams = {
      response_type: urlParams.get('response_type'),
      client_id: urlParams.get('client_id'),
      redirect_uri: urlParams.get('redirect_uri'),
      state: urlParams.get('state'),
      scope: urlParams.get('scope'),
      code_challenge: urlParams.get('code_challenge'),
      code_challenge_method: urlParams.get('code_challenge_method'),
      resource: urlParams.get('resource'),
    };

    let availableTools = [];
    let selectedTools = new Set();

    // Check if we have required OAuth parameters
    // Note: state is optional in OAuth 2.1 with PKCE (though recommended)
    if (!oauthParams.client_id || !oauthParams.redirect_uri) {
      showError('Invalid authorization request. Missing required parameters.');
      document.getElementById('btn-authorize').disabled = true;
    }

    // Initialize
    async function init() {
      try {
        // Load session
        await loadSession();
        
        // Load available tools
        await loadTools();
        
        // Auto-select all tools by default
        const allCheckboxes = document.querySelectorAll('.permission-item input[type="checkbox"]');
        allCheckboxes.forEach(cb => {
          cb.checked = true;
        });
        document.getElementById('select-all').checked = true;
        updateSelectedTools();
        
        // Show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        showError(error.message);
      }
    }

    // Load user session
    async function loadSession() {
      try {
        console.log('[Authorize] Fetching session from /api/auth/session');
        const response = await fetch('/api/auth/session', {
          credentials: 'include',
        });

        console.log('[Authorize] Session response:', response.status, response.statusText);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[Authorize] Session error:', errorText);
          throw new Error('Not authenticated');
        }

        const session = await response.json();
        console.log('[Authorize] Session data:', session);
        
        if (session?.user?.email) {
          document.getElementById('user-email').textContent = session.user.email;
        } else {
          throw new Error('No session found');
        }
      } catch (error) {
        console.error('[Authorize] Failed to load session:', error);
        // Redirect to sign-in with OAuth parameters
        // Filter out null values from OAuth params
        const validParams = {};
        Object.entries(oauthParams).forEach(([key, value]) => {
          if (value !== null && value !== undefined) {
            validParams[key] = value;
          }
        });
        const params = new URLSearchParams(validParams);
        console.log('[Authorize] Redirecting to sign-in with params:', params.toString());
        window.location.href = `/sign-in?${params.toString()}`;
      }
    }

    // Load available tools
    async function loadTools() {
      const response = await fetch('/api/tools/management');
      if (!response.ok) {
        throw new Error('Failed to load tools');
      }

      const data = await response.json();
      availableTools = data.tools;
      
      renderTools(data.grouped);
    }

    // Render tools grouped by category
    function renderTools(grouped) {
      const container = document.getElementById('permissions-container');
      container.innerHTML = '';

      for (const [category, tools] of Object.entries(grouped)) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'permission-category';
        
        const categoryTitle = document.createElement('h4');
        categoryTitle.textContent = category;
        categoryDiv.appendChild(categoryTitle);

        for (const tool of tools) {
          const item = document.createElement('div');
          item.className = 'permission-item';
          if (tool.dangerous) {
            item.classList.add('dangerous');
          }

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `tool-${tool.name}`;
          checkbox.value = tool.name;
          checkbox.addEventListener('change', onToolToggle);

          const content = document.createElement('div');
          content.className = 'permission-content';

          const name = document.createElement('div');
          name.className = 'permission-name';
          name.textContent = tool.name;

          const description = document.createElement('div');
          description.className = 'permission-description';
          description.textContent = tool.description;
          if (tool.dangerous) {
            description.textContent += ' (⚠️ Dangerous operation)';
          }

          content.appendChild(name);
          content.appendChild(description);

          item.appendChild(checkbox);
          item.appendChild(content);
          
          item.addEventListener('click', (e) => {
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event('change'));
            }
          });

          categoryDiv.appendChild(item);
        }

        container.appendChild(categoryDiv);
      }

      // Select all checkbox
      document.getElementById('select-all').addEventListener('change', (e) => {
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
        });
        updateSelectedTools();
      });
    }

    // Handle tool toggle
    function onToolToggle(e) {
      updateSelectedTools();
    }

    // Update selected tools set and count
    function updateSelectedTools() {
      const checkboxes = document.querySelectorAll('.permission-item input[type="checkbox"]:checked');
      selectedTools = new Set(Array.from(checkboxes).map(cb => cb.value));
      
      const count = selectedTools.size;
      document.getElementById('selected-count').textContent = 
        `${count} permission${count !== 1 ? 's' : ''} selected`;
      
      // Update select-all checkbox
      const allCheckboxes = document.querySelectorAll('.permission-item input[type="checkbox"]');
      const selectAllCheckbox = document.getElementById('select-all');
      selectAllCheckbox.checked = count === allCheckboxes.length;
      selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
    }

    // Authorize button
    document.getElementById('btn-authorize').addEventListener('click', async () => {
      const btn = document.getElementById('btn-authorize');
      
      if (selectedTools.size === 0) {
        showError('Please select at least one permission to grant.');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Authorizing...';

      try {
        // Build scopes with mcp:* for all management tools
        // Format: "openid profile email offline_access mcp:*"
        const baseScopes = oauthParams.scope || 'openid profile email offline_access';
        const mcpScope = 'mcp:*'; // Grant all management tools
        const allScopes = `${baseScopes} ${mcpScope}`;

        // Build authorization URL with updated scopes
        const params = new URLSearchParams();
        Object.entries(oauthParams).forEach(([key, value]) => {
          if (value && key !== 'scope') {
            params.append(key, value);
          }
        });
        params.append('scope', allScopes);

        const finalUrl = `/api/auth/authorize?${params.toString()}`;
        
        console.log('[Authorize] Original scopes:', oauthParams.scope);
        console.log('[Authorize] Updated scopes:', allScopes);
        console.log('[Authorize] Full URL:', finalUrl);
        console.log('[Authorize] All params:', Object.fromEntries(params.entries()));

        // Redirect to Better Auth's authorization endpoint
        // Better Auth will generate the code and redirect to client
        window.location.href = finalUrl;
      } catch (error) {
        showError(error.message || 'Authorization failed. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Authorize';
      }
    });

    // Deny button
    document.getElementById('btn-deny').addEventListener('click', () => {
      // Redirect back to client with error
      const redirectUrl = new URL(oauthParams.redirect_uri);
      redirectUrl.searchParams.append('error', 'access_denied');
      redirectUrl.searchParams.append('error_description', 'User denied authorization');
      if (oauthParams.state) {
        redirectUrl.searchParams.append('state', oauthParams.state);
      }
      
      window.location.href = redirectUrl.toString();
    });

    // Helper functions
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    // Log for debugging
    console.log('[Authorize Page] Loaded with OAuth params:', oauthParams);
    console.log('[Authorize Page] Current URL:', window.location.href);

    // Initialize on load
    init();
  </script>
</body>
</html>
